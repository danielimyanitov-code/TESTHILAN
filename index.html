<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>שליפת נתונים מדוח שעות PDF</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;padding:20px;background:#f7f7f7}
    .card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    input[type=file]{padding:10px;border:1px solid #ddd;border-radius:8px;background:#fff}
    button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer;background:#2b7cff;color:#fff}
    table{width:100%;border-collapse:collapse;margin-top:14px;background:#fff}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:right}
    th{background:#fafafa}
    .small{font-size:.9rem;color:#666}
    .ok{color:#0a7b10}.miss{color:#b00020}
  </style>
</head>
<body>
  <div class="card">
    <h1>מעלה PDF ⇒ שליפת נתונים</h1>
    <div class="row">
      <input id="file" type="file" accept="application/pdf" />
      <button id="run">שלוף נתונים</button>
    </div>
    <div id="status" class="small" style="margin-top:8px;"></div>
  </div>

  <table id="results" style="display:none">
    <thead><tr><th>שדה</th><th>ערך שנמצא</th><th>סטטוס</th></tr></thead>
    <tbody></tbody>
  </table>
  <a id="dl" class="small" style="display:none" download>הורד Word</a>

  <script src="https://cdn.jsdelivr.net/npm/html-docx-js@0.4.1/dist/html-docx.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
  <script type="module">
    // --- טעינת PDF.js מהאתר עם נפילה אוטומטית ל-CDN ---
    const loadPdfjs = async () => {
      const LOCAL = '/vendor/pdfjs/';
      const CDN = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.8.69/es5/build/';
      try {
        const lib = await import(LOCAL + 'pdf.mjs');
        if (!lib?.GlobalWorkerOptions) throw new Error('bad local pdfjs');
        lib.GlobalWorkerOptions.workerSrc = LOCAL + 'pdf.worker.mjs';
        return lib;
      } catch (err) {
        console.warn('לא נמצא קובץ לוקאלי, יורד ל-CDN', err);
        const lib = await import(CDN + 'pdf.mjs');
        lib.GlobalWorkerOptions.workerSrc = CDN + 'pdf.worker.mjs';
        return lib;
      }
    };
    const pdfjsLib = await loadPdfjs();

    const $status = document.getElementById('status');
    const $dl = document.getElementById('dl');
    const setStatus = m => $status.textContent = m;

    // ===== עזרי RTL =====
    const clean = s => s.replace(/\u200f|\u200e|\u202a|\u202b|\u202c|\u202d|\u202e/g,'').replace(/\s+/g,' ').trim();
    const reverse = s => [...s].reverse().join('');
    const variants = term => {
      const v=new Set, t=clean(term);
      v.add(t); v.add(reverse(t));
      v.add(t.replace(/"/g,'״')); v.add(reverse(t.replace(/"/g,'״')));
      v.add(t.replace(/״/g,'"')); v.add(reverse(t.replace(/״/g,'"')));
      return [...v];
    };
    const escapeHtml = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const findNear = (text, keys, rx) => {
      for (const k of keys) {
        const i=text.indexOf(k);
        if (i!==-1){ const s=text.slice(Math.max(0,i-60), i+k.length+120); const m=s.match(rx); if(m) return m[0]; }
      }
      return null;
    };

    const TIME=/\b\d{1,3}:\d{2}\b/;
    const NUMBER=/\b\d+(?:\.\d+)?\b/;
    const fields=[
      {label:'סה"כ לשכר',keys:variants('סה"כ לשכר'),rx:TIME},
      {label:'סה"כ נוכחות',keys:variants('סה"כ נוכחות'),rx:TIME},
      {label:'שעות תקן',keys:variants('שעות תקן'),rx:TIME},
      {label:'שעות 125%',keys:variants('שעות 125%'),rx:TIME},
      {label:'שעות 150%',keys:variants('שעות 150%'),rx:TIME},
      {label:'משמרת א',keys:variants('משמרת א'),rx:TIME},
      {label:'משמרת ב',keys:variants('משמרת ב'),rx:TIME},
      {label:'משמרת ג',keys:variants('משמרת ג'),rx:TIME},
      {label:'חופשה 481',keys:[...variants('חופשה 481'),...variants('481-חופשה')],rx:NUMBER},
      {label:'אש"ל 302',keys:[...variants('302-אש"ל'),...variants('אש"ל 302'),...variants('302 אש"ל')],rx:NUMBER},
    ];

    async function extractTextFromPdf(file, opts = {}) {
      const buf = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buf, ...opts }).promise;
      let full = '';
      for (let p = 1; p <= pdf.numPages; p++) {
        const page = await pdf.getPage(p);
        const content = await page.getTextContent();
        full += '\n' + content.items.map(i => i.str).join(' ');
      }
      const n = clean(full), r = reverse(n);
      return n + '\n' + r;
    }

    const $file = document.getElementById('file');
    const $run = document.getElementById('run');
    const $table = document.getElementById('results');
    const $tbody = $table.querySelector('tbody');
    const addRow = (name,value)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${name}</td><td>${value??'לא נמצא'}</td><td>${value?'<span class="ok">נמצא</span>':'<span class="miss">חסר</span>'}</td>`;
      $tbody.appendChild(tr);
    };

    async function processWord(text, file){
      const html = '<p>'+escapeHtml(text).replace(/\n/g,'<br>')+'</p>';
      const blob = window.htmlDocx.asBlob(html);
      $dl.href = URL.createObjectURL(blob);
      $dl.download = file.name.replace(/\.pdf$/i,'.docx');
      $dl.style.display='inline';
      const buf = await blob.arrayBuffer();
      const { value } = await window.mammoth.extractRawText({ arrayBuffer: buf });
      const t = clean(value);
      const combined = t+'\n'+reverse(t);
      fields.forEach(f=>addRow(f.label,findNear(combined,f.keys,f.rx)));
      $table.style.display='';
    }

    $run.addEventListener('click', async () => {
      const file = $file.files?.[0];
      if (!file) { setStatus('בחר/י קובץ PDF.'); return; }
      $tbody.innerHTML=''; $table.style.display='none'; $dl.style.display='none';
      setStatus('ממיר ל-Word ומחלץ נתונים…');

      try {
        const text = await extractTextFromPdf(file);
        await processWord(text, file);
        setStatus('בוצע דרך Word.');
      } catch (err1) {
        console.warn('Worker probably blocked, retrying without worker…', err1);
        try {
          const text = await extractTextFromPdf(file, { disableWorker: true });
          await processWord(text, file);
          setStatus('בוצע דרך Word (ללא Worker).');
        } catch (err2) {
          console.error(err2);
          setStatus('שגיאה בקריאת הקובץ. ודא/י שה-PDF טקסטואלי ושהקבצים ב-/vendor/pdfjs קיימים.');
        }
      }
    });
  </script>
</body>
</html>
